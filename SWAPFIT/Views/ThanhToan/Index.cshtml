<<<<<<< HEAD
Ôªø@model SWAPFIT.Models.GioHangViewModel

<style>
    .checkout-container {
        font-family: 'Arial', sans-serif;
        max-width: 800px;
        margin: auto;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .checkout-header h2 {
        font-size: 24px;
        color: #333;
    }

    .form-label {
        font-size: 16px;
        font-weight: 600;
        color: #444;
    }

    .table th {
        background-color: #e9ecef;
        font-weight: bold;
    }

    .table td {
        vertical-align: middle;
    }

    .product-img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        margin-right: 10px;
    }

    .total-box {
        background-color: #e8f5e9;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #phiShipAlert {
        background-color: #d1e7dd;
        border-radius: 5px;
        padding: 10px;
        margin-top: 10px;
    }

    .btn-success {
        padding: 10px 20px;
        font-size: 16px;
    }

    @@media screen and (max-width: 768px) {
        .checkout-container {
            width: 100%;
            padding: 10px;
        }

        .table th, .table td {
            padding: 8px;
        }
=======
Ôªø@model SWAPFIT.Models.GioHang
@using SWAPFIT.Model

@{
    ViewData["Title"] = "X√°c nh·∫≠n thanh to√°n";
    decimal tongTien = 0;

    var userVouchers = ViewBag.UserVouchers as List<UserVoucher>;
}


<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
    body {
        background-color: #f7fdf8;
        font-family: "Segoe UI", sans-serif;
    }

    .checkout-container {
        max-width: 900px;
        margin: 40px auto;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        padding: 30px;
    }

    .checkout-header {
        border-bottom: 2px solid #e6f5e9;
        margin-bottom: 25px;
        padding-bottom: 10px;
    }

        .checkout-header h2 {
            color: #2e7d32;
            font-weight: 700;
        }

    .table th {
        background-color: #a5d6a7 !important;
        color: #1b5e20;
        font-weight: 600;
    }

    .product-img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #ddd;
        margin-right: 10px;
    }

    .form-label {
        font-weight: 600;
        color: #2e7d32;
    }

    .radio-box {
        background-color: #f1f8f2;
        border: 1px solid #d0e9d2;
        border-radius: 10px;
        padding: 10px 15px;
        margin-bottom: 10px;
        transition: 0.3s;
    }

        .radio-box:hover {
            border-color: #81c784;
            background-color: #e8f5e9;
        }

    .total-box {
        background-color: #e8f5e9;
        border-radius: 10px;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 25px;
    }

    .btn-success {
        background-color: #43a047;
        border: none;
        transition: 0.3s;
    }

        .btn-success:hover {
            background-color: #2e7d32;
        }

    .alert-fee {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
        padding: 10px 15px;
        border-radius: 8px;
        display: none;
        margin-top: 10px;
>>>>>>> cff493713bfe5280dbb98db99eb56a2baceef7ff
    }
</style>

<div class="checkout-container">
<<<<<<< HEAD
    <div class="checkout-header d-flex justify-content-between align-items-center mb-4">
        <h2>X√°c nh·∫≠n thanh to√°n</h2>
        <a asp-controller="GioHang" asp-action="Index" class="btn btn-outline-success btn-sm">
            Quay l·∫°i gi·ªè h√†ng
        </a>
    </div>

    <form asp-action="XacNhanThanhToan" method="post">
        <!-- ƒê·ªãa ch·ªâ giao h√†ng -->
        <div class="mb-4">
            <label class="form-label">ƒê·ªãa ch·ªâ giao h√†ng</label>
            <input type="text" name="diaChiGiaoHang" class="form-control" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ nh·∫≠n h√†ng c·ªßa b·∫°n..." required />
=======
    <div class="checkout-header d-flex justify-content-between align-items-center">
        <h2>üí≥ X√°c nh·∫≠n thanh to√°n</h2>
        <a asp-controller="GioHang" asp-action="Index" class="btn btn-outline-success btn-sm">
            <i class="bi bi-arrow-left"></i> Quay l·∫°i gi·ªè h√†ng
        </a>
    </div>

    <!-- Form ƒë·∫∑t h√†ng -->
    <form asp-action="DatHang" asp-controller="GioHang" method="post">
        @Html.AntiForgeryToken()

        <!-- ƒê·ªãa ch·ªâ giao h√†ng -->
        <div class="mb-4">
            <label class="form-label">üìç ƒê·ªãa ch·ªâ giao h√†ng</label>
            <input type="text"
                   name="diaChiGiaoHang"
                   class="form-control"
                   placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ nh·∫≠n h√†ng c·ªßa b·∫°n..."
                   required />
>>>>>>> cff493713bfe5280dbb98db99eb56a2baceef7ff
        </div>

        <!-- Ph∆∞∆°ng th·ª©c thanh to√°n -->
        <div class="mb-4">
<<<<<<< HEAD
            <label class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="phuongThucThanhToan" value="COD" checked />
                <label class="form-check-label">Thanh to√°n khi nh·∫≠n h√†ng (COD)</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="phuongThucThanhToan" value="ChuyenKhoan" />
                <label class="form-check-label">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</label>
            </div>
        </div>

        <!-- Ph∆∞∆°ng th·ª©c giao h√†ng -->
        <div class="mb-4">
            <label class="form-label">Ph∆∞∆°ng th·ª©c giao h√†ng</label>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="phuongThucGiaoHang" value="GiaoTanNoi" checked />
                <label class="form-check-label">Giao t·∫≠n n∆°i (2‚Äì4 ng√†y)</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="phuongThucGiaoHang" value="NhanTaiDiem" />
                <label class="form-check-label">Nh·∫≠n t·∫°i ƒëi·ªÉm giao (mi·ªÖn ph√≠ ship)</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="phuongThucGiaoHang" value="GiaoNhanh" />
                <label class="form-check-label">Giao h·ªèa t·ªëc (n·ªôi th√†nh trong 4 gi·ªù)</label>
            </div>
            <div id="phiShipAlert" class="alert alert-info mt-2" style="display: none;">
                ƒê√£ c·ªông 50.000ƒë ph√≠ giao h·ªèa t·ªëc v√†o t·ªïng ti·ªÅn.
=======
            <label class="form-label">üí∞ Ph∆∞∆°ng th·ª©c thanh to√°n</label>
            <div class="radio-box">
                <input class="form-check-input me-2"
                       type="radio"
                       name="phuongThucThanhToan"
                       value="COD"
                       checked />
                <label class="form-check-label">Thanh to√°n khi nh·∫≠n h√†ng (COD)</label>
            </div>
            <div class="radio-box">
                <input class="form-check-input me-2"
                       type="radio"
                       name="phuongThucThanhToan"
                       value="ChuyenKhoan" />
                <label class="form-check-label">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</label>
            </div>
        </div>
        <!-- Ch·ªçn khuy·∫øn m√£i ƒë√£ l∆∞u -->
        <div class="mb-4">
            <label class="form-label">üéÅ Ch·ªçn khuy·∫øn m√£i ƒë√£ l∆∞u</label>
            <select class="form-select" id="voucherId" name="voucherId">
                <option value="">-- Kh√¥ng s·ª≠ d·ª•ng khuy·∫øn m√£i --</option>

                @if (userVouchers != null && userVouchers.Any())
                {
                    foreach (var uv in userVouchers)
                    {
                        var v = uv.Voucher;
                        <option value="@uv.VoucherId"
                                data-loai="@v.LoaiUuDai"
                                data-giatri="@v.GiaTri">
                            @v.TenUuDai
                            (@(v.LoaiUuDai == "PhanTram"
                                                ? $"Gi·∫£m {v.GiaTri}%"
                                                : $"Gi·∫£m {v.GiaTri:N0} ƒë"))
                    - HSD: @v.NgayKetThuc.ToString("dd/MM/yyyy")
                </option>
                                }
                }
            </select>
        </div>

        <!-- Ph∆∞∆°ng th·ª©c giao h√†ng -->
        <div class="mb-4">
            <label class="form-label">üöö Ph∆∞∆°ng th·ª©c giao h√†ng</label>
            <div class="radio-box">
                <input class="form-check-input me-2"
                       type="radio"
                       name="phuongThucGiaoHang"
                       value="GiaoTanNoi"
                       checked />
                <label class="form-check-label">Giao t·∫≠n n∆°i (2‚Äì4 ng√†y)</label>
            </div>
            <div class="radio-box">
                <input class="form-check-input me-2"
                       type="radio"
                       name="phuongThucGiaoHang"
                       value="NhanTaiDiem" />
                <label class="form-check-label">Nh·∫≠n t·∫°i ƒëi·ªÉm giao (mi·ªÖn ph√≠ ship)</label>
            </div>
            <div class="radio-box">
                <input id="radioGiaoNhanh"
                       class="form-check-input me-2"
                       type="radio"
                       name="phuongThucGiaoHang"
                       value="GiaoNhanh" />
                <label class="form-check-label">Giao h·ªèa t·ªëc (n·ªôi th√†nh trong 4 gi·ªù)</label>
            </div>

            <div id="phiShipAlert" class="alert-fee">
                üöÄ ƒê√£ c·ªông 50.000ƒë ph√≠ giao h·ªèa t·ªëc v√†o t·ªïng ti·ªÅn.
>>>>>>> cff493713bfe5280dbb98db99eb56a2baceef7ff
            </div>
        </div>

        <!-- Danh s√°ch s·∫£n ph·∫©m -->
<<<<<<< HEAD
        <table class="table table-hover align-middle text-center table-striped">
            <thead class="table-light">
=======
        <table class="table table-hover align-middle text-center">
            <thead>
>>>>>>> cff493713bfe5280dbb98db99eb56a2baceef7ff
                <tr>
                    <th style="width: 300px;">S·∫£n ph·∫©m</th>
                    <th>S·ªë l∆∞·ª£ng</th>
                    <th>Gi√°</th>
                    <th>Th√†nh ti·ªÅn</th>
                </tr>
            </thead>
            <tbody>
<<<<<<< HEAD
                @if (Model.GioHang != null && Model.GioHang.ChiTietGioHangs.Any())
                {
                    foreach (var item in Model.GioHang.ChiTietGioHangs)
                    {
                        var thanhTien = (item.BaiViet.GiaSanPham ?? 0m) * item.SoLuong;
                        <tr>
                            <td class="text-start d-flex align-items-center">
                                <img src="@Url.Content(item.BaiViet.AnhBaiViets?.FirstOrDefault()?.DuongDan ?? "/images/no-image.png")" class="product-img" alt="Product" />
                                <div class="ms-2">
                                    <span class="fw-semibold d-block">@item.BaiViet.TieuDe</span>
                                </div>
                            </td>
                            <td>@item.SoLuong</td>
                            <td>@string.Format("{0:N0} ƒë", item.BaiViet.GiaSanPham ?? 0m)</td>
                            <td class="text-success fw-bold">@thanhTien.ToString("N0") ƒë</td>
                        </tr>
                    }
                }
                else if (Model.GioHangTam != null && Model.GioHangTam.Any())
                {
                    foreach (var item in Model.GioHangTam)
                    {
                        var thanhTien = item.GiaSanPham * item.SoLuong;
                        <tr>
                            <td class="text-start d-flex align-items-center">
                                <img src="@Url.Content(item.AnhSanPham ?? "/images/no-image.png")" class="product-img" alt="Product" />
                                <div class="ms-2">
                                    <span class="fw-semibold d-block">@item.TenSanPham</span>
                                </div>
                            </td>
                            <td>@item.SoLuong</td>
                            <td>@string.Format("{0:N0} ƒë", item.GiaSanPham)</td>
                            <td class="text-success fw-bold">@thanhTien.ToString("N0") ƒë</td>
                        </tr>
                    }
=======
                @foreach (var item in Model.ChiTietGioHangs)
                {
                    var thanhTien = (item.BaiViet.GiaSanPham ?? 0) * item.SoLuong;
                    tongTien += thanhTien;

                    // l·∫•y ·∫£nh an to√†n
                    string anh = null;
                    if (item.BaiViet?.AnhBaiViets != null && item.BaiViet.AnhBaiViets.Any())
                    {
                        anh = item.BaiViet.AnhBaiViets.First().DuongDan;
                    }
                    var anhHienThi = !string.IsNullOrEmpty(anh)
                    ? (anh.StartsWith("/") ? anh : "/" + anh)
                    : Url.Content("~/images/no-image.png");

                    <tr>
                        <td class="text-start d-flex align-items-center">
                            <img src="@anhHienThi" alt="·∫¢nh s·∫£n ph·∫©m" class="product-img" />
                            <div class="ms-2 text-start">
                                <span class="fw-semibold d-block">@item.BaiViet.TieuDe</span>
                                <small class="text-muted">
                                    Ng∆∞·ªùi b√°n: @item.BaiViet.NguoiDung?.TenDangNhap
                                </small>
                            </div>
                        </td>
                        <td>@item.SoLuong</td>
                        <td>@((item.BaiViet.GiaSanPham ?? 0).ToString("N0")) ƒë</td>
                        <td class="text-success fw-bold">@thanhTien.ToString("N0") ƒë</td>
                    </tr>
>>>>>>> cff493713bfe5280dbb98db99eb56a2baceef7ff
                }
            </tbody>
        </table>

<<<<<<< HEAD
        <!-- VOUCHER -->
        <div class="my-4">
            <label class="form-label fw-bold">Ch·ªçn Voucher</label>
            <select id="voucherSelect" name="voucherId" class="form-control">
                <option value="">-- Ch·ªçn voucher ƒë√£ l∆∞u --</option>
                @if (ViewBag.UserVouchers != null && ((System.Collections.IEnumerable)ViewBag.UserVouchers).Cast<object>().Any())
                {
                    foreach (var v in ViewBag.UserVouchers)
                    {
                        <option value="@v.MaUuDai"
                                data-loai="@v.LoaiUuDai"
                                data-giaTri="@v.GiaTri">
                            @v.TenUuDai - Gi·∫£m @(v.LoaiUuDai == "PhanTram" ? $"{v.GiaTri}%" : $"{v.GiaTri:N0}ƒë")
                        </option>
                    }
                }
                else
                {
                    <option value="" disabled>Ch∆∞a c√≥ voucher n√†o</option>
                }
            </select>
        </div>

        <!-- T·ªîNG TI·ªÄN ‚Äì D√ôNG CHUNG ViewBag.TongTien -->
        <div class="total-box mb-4">
            <h5 class="mb-0">T·ªïng c·ªông:</h5>
            @{
                var tongHienThi = ViewBag.TongTien as decimal? ?? 0m;
            }
            <h4 id="tongTienHienThi" class="text-success fw-bold mb-0">
                @tongHienThi.ToString("N0") ƒë
            </h4>
            <input type="hidden" id="tongTienInput" name="tongTien" value="@tongHienThi" />
=======
        <!-- T·ªïng ti·ªÅn -->
        <div class="total-box">
            <h5 class="mb-0">T·ªïng c·ªông:</h5>
            <h4 id="tongTienHienThi" class="text-success fw-bold mb-0">
                @tongTien.ToString("N0") ƒë
            </h4>
            <input type="hidden"
                   id="tongTienInput"
                   name="tongTien"
                   value="@tongTien" />
>>>>>>> cff493713bfe5280dbb98db99eb56a2baceef7ff
        </div>

        <div class="text-end mt-4">
            <button type="submit" class="btn btn-success px-4 py-2">
<<<<<<< HEAD
                X√°c nh·∫≠n ƒë·∫∑t h√†ng
=======
                <i class="bi bi-cash-stack"></i> X√°c nh·∫≠n ƒë·∫∑t h√†ng
>>>>>>> cff493713bfe5280dbb98db99eb56a2baceef7ff
            </button>
        </div>
    </form>
</div>

<<<<<<< HEAD
<!-- SCRIPT HO√ÄN H·∫¢O ‚Äì GI·∫¢M % + C·ªòNG PH√ç SHIP REALTIME -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const tongTienGoc = @Html.Raw(Json.Serialize(ViewBag.TongTien ?? 0m));
        const voucherSelect = document.getElementById("voucherSelect");
        const tongTienHienThi = document.getElementById("tongTienHienThi");
        const tongTienInput = document.getElementById("tongTienInput");
        const phiShipAlert = document.getElementById("phiShipAlert");

        // Update function to handle voucher selection and discount calculation
        function capNhatTongTien() {
            let tong = tongTienGoc;

            // 1. Ki·ªÉm tra ph√≠ ship
            const giaoNhanh = document.querySelector('input[name="phuongThucGiaoHang"]:checked')?.value === "GiaoNhanh";
            if (giaoNhanh) {
                tong += 50000;
                phiShipAlert.style.display = "block";  // Hi·ªÉn th·ªã ph√≠ ship
            } else {
                phiShipAlert.style.display = "none";  // ·∫®n ph√≠ ship
            }

            // 2. Ki·ªÉm tra n·∫øu t·ªïng ti·ªÅn b·∫±ng 0 th√¨ kh√¥ng √°p d·ª•ng voucher
            if (tong === 0) {
                // Disable voucher select if total is 0
                voucherSelect.disabled = true;
                console.log("Total is 0, voucher cannot be applied.");
            } else {
                // Enable voucher select if total is not 0
                voucherSelect.disabled = false;
            }

            // 3. L·∫•y gi√° tr·ªã voucher n·∫øu t·ªïng ti·ªÅn kh√¥ng ph·∫£i 0
            if (voucherSelect.value && tong !== 0) {
                const selectedOption = voucherSelect.querySelector(`option[value='${voucherSelect.value}']`);
                const loaiVoucher = selectedOption ? selectedOption.dataset.loai : null;
                const giaTriVoucher = selectedOption ? parseFloat(selectedOption.dataset.giatri) : 0;

                console.log("Voucher ID:", voucherSelect.value);
                console.log("Voucher Type:", loaiVoucher);
                console.log("Voucher Value:", giaTriVoucher);

                // Apply voucher discount
                if (loaiVoucher === "PhanTram") {
                    tong -= tong * giaTriVoucher / 100;  // Gi·∫£m theo % n·∫øu voucher l√† gi·∫£m theo ph·∫ßn trƒÉm
                } else if (loaiVoucher === "TienMat") {
                    tong = Math.max(0, tong - giaTriVoucher);  // Gi·∫£m theo gi√° tr·ªã c·ª• th·ªÉ
                }
            }

            // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn sau khi t√≠nh to√°n
            tong = Math.round(tong);
            tongTienHienThi.textContent = tong.toLocaleString('vi-VN') + " ƒë";  // Hi·ªÉn th·ªã t·ªïng ti·ªÅn
            tongTienInput.value = tong;  // C·∫≠p nh·∫≠t gi√° tr·ªã ·∫©n cho form
        }

        // G·ªçi h√†m t√≠nh to√°n khi c√≥ thay ƒë·ªïi
        capNhatTongTien();
        voucherSelect.addEventListener("change", capNhatTongTien);  // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi voucher
        document.querySelectorAll('input[name="phuongThucGiaoHang"]').forEach(radio => {
            radio.addEventListener("change", capNhatTongTien);  // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi ph∆∞∆°ng th·ª©c giao h√†ng
        });
    });
=======
<script>
    const radioNhanh = document.getElementById("radioGiaoNhanh");
    const phiShipAlert = document.getElementById("phiShipAlert");
    const tongTienHienThi = document.getElementById("tongTienHienThi");
    const tongTienInput = document.getElementById("tongTienInput");
    const selectVoucher = document.getElementById("voucherId");

    // T·ªïng ti·ªÅn g·ªëc c·ªßa s·∫£n ph·∫©m (ch∆∞a ship, ch∆∞a gi·∫£m)
    const tongTienGoc = parseFloat("@tongTien");

    function capNhatTongTien() {
        let tongTienMoi = tongTienGoc;

        // 1. T√≠nh ph√≠ ship n·∫øu giao nhanh
        let phiShip = 0;
        if (radioNhanh && radioNhanh.checked) {
            phiShip = 50000;
            phiShipAlert.style.display = "block";
        } else {
            phiShipAlert.style.display = "none";
        }
        tongTienMoi += phiShip;

        // 2. T√≠nh s·ªë ti·ªÅn gi·∫£m t·ª´ voucher
        let giamGia = 0;
        if (selectVoucher && selectVoucher.value) {
            const opt = selectVoucher.options[selectVoucher.selectedIndex];
            const loai = opt.getAttribute("data-loai");          // PhanTram / TienMat
            const giaTri = parseFloat(opt.getAttribute("data-giatri") || "0");

            if (!isNaN(giaTri) && giaTri > 0) {
                if (loai === "PhanTram") {
                    // Gi·∫£m theo %
                    giamGia = tongTienGoc * giaTri / 100;
                } else {
                    // Gi·∫£m s·ªë ti·ªÅn c·ªë ƒë·ªãnh
                    giamGia = giaTri;
                }
            }
        }

        tongTienMoi -= giamGia;
        if (tongTienMoi < 0) tongTienMoi = 0;

        // 3. C·∫≠p nh·∫≠t UI + hidden input
        tongTienHienThi.textContent = tongTienMoi.toLocaleString('vi-VN') + " ƒë";
        tongTienInput.value = tongTienMoi;
    }

    // Khi ƒë·ªïi ph∆∞∆°ng th·ª©c giao h√†ng
    document.querySelectorAll('input[name="phuongThucGiaoHang"]').forEach(radio => {
        radio.addEventListener("change", capNhatTongTien);
    });

    // Khi ch·ªçn / ƒë·ªïi voucher
    if (selectVoucher) {
        selectVoucher.addEventListener("change", capNhatTongTien);
    }

    // G·ªçi 1 l·∫ßn khi load trang ƒë·ªÉ set ƒë√∫ng ngay t·ª´ ƒë·∫ßu
    capNhatTongTien();
>>>>>>> cff493713bfe5280dbb98db99eb56a2baceef7ff
</script>
