<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
    .chat-container .chat-header img {
        width: 45px;
        height: 45px;
        object-fit: cover;
        border-radius: 50%;
    }

    .chat-container .msg-other img.avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }

    .chat-container {
        max-width: 800px;
        margin: auto;
        background: #ffffff;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    #chat-box {
        height: 450px; 
        overflow-y: auto;
        padding: 15px;
        background: #f9f9f9;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .bubble {
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 15px;
        line-height: 1.5;
        display: inline-block;
        max-width: 80%;
        word-wrap: break-word;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease-in-out;
    }

    .msg-me .bubble {
        background-color: #28a745; 
        color: white;
        margin-left: auto;
    }

    .msg-other .bubble {
        background-color: #e4e6eb; 
        color: black;
    }

    .chat-input-area {
        background: white;
        border-top: 1px solid #e5e7eb;
        padding: 12px 15px;
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .chat-input {
        flex: 1;
        border: 1px solid #ccc;
        border-radius: 25px;
        padding: 10px 15px;
        font-size: 14px;
        outline: none;
    }

    .btn-send {
        background: #007bff;
        border: none;
        color: white;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        cursor: pointer;
        transition: background 0.3s ease;
    }

        .btn-send:hover {
            background: #0056b3;
        }

    .time {
        font-size: 12px;
        color: #888;
        margin-top: 5px;
    }

    .bubble:hover {
        transform: scale(1.05);
    }
</style>

<div class="chat-container">
    <div class="chat-header">
        <img src="@(ViewBag.OtherUser.AnhDaiDien ?? "/images/default-avatar.png")">
        <div>
            <h5 class="mb-0">@ViewBag.OtherUser.HoTen</h5>
            <small>Đang trò chuyện</small>
        </div>
    </div>

    <div id="chat-box">
        @if (Model != null)
        {
            foreach (var m in Model)
            {
                bool isMe = m.MaNguoiGui == @Context.Session.GetInt32("MaNguoiDung");

                <div class="@(isMe ? "msg-me" : "msg-other")">
                    @if (!isMe)
                    {
                        <img src="@(ViewBag.OtherUser.AnhDaiDien ?? "/images/default-avatar.png")" class="avatar" />
                    }

                    <div>
                        <div class="bubble">@m.NoiDung</div>
                        <div class="time">@m.ThoiGianGui?.ToString("HH:mm dd/MM")</div>
                    </div>
                </div>
            }
        }
    </div>

    <form asp-controller="TinNhan" asp-action="GuiTinNhan" method="post" class="d-flex gap-2">
        @Html.AntiForgeryToken()
        <input type="hidden" name="nguoiNhanId" value="@ViewBag.OtherUser.MaNguoiDung" />
        <input name="noiDung" class="form-control" placeholder="Nhập tin nhắn..." />
        <button class="btn btn-success" type="submit">Gửi</button>
    </form>

</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>

    <script>
        const me = @Context.Session.GetInt32("MaNguoiDung");
        const other = @ViewBag.OtherUser.MaNguoiDung;

        const connection = new signalR.HubConnectionBuilder().withUrl("/chathub").build();

        connection.start().then(() => {
            connection.invoke("JoinConversation", me, other);
        });

        connection.on("ReceiveMessage", function (senderId, message, time) {
            const isMe = senderId == me;

            $("#chat-box").append(`
                <div class="${isMe ? "msg-me" : "msg-other"}">

                    ${!isMe ? `<img src='@ViewBag.OtherUser.AnhDaiDien' class='avatar'/>` : ""}

                    <div>
                        <div class="bubble">${message}</div>
                        <div class="time">${time}</div>
                    </div>

                </div>
            `);

            const box = document.getElementById("chat-box");
            box.scrollTop = box.scrollHeight;
        });

        $("#btnSend").click(sendMsg);
        $("#msg").keypress(e => { if (e.which === 13) sendMsg(); });

        function sendMsg() {
            let message = $("#msg").val().trim();
            if (message === "") return;

            connection.invoke("SendMessage", me, other, message);
            $("#msg").val(""); 
        }

        document.getElementById("chat-box").scrollTop = document.getElementById("chat-box").scrollHeight;
    </script>
}
